openapi: 3.0.3
info:
  title: ClinicLite Botswana API with No-Show Prediction
  description: |
    RESTful API for ClinicLite system enhanced with predictive analytics for no-show reduction
    and intelligent scheduling optimization. Supports offline-first operation with sync capabilities.
  version: 2.0.0
  contact:
    name: ClinicLite Support
    email: support@cliniclite.bw
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8000/api
    description: Development server
  - url: https://api.cliniclite.bw/api
    description: Production server

tags:
  - name: Core
    description: Basic clinic operations
  - name: Predictions
    description: No-show risk prediction endpoints
  - name: Scheduling
    description: Smart scheduling and overbooking
  - name: Waitlist
    description: Waitlist management
  - name: SMS
    description: Two-way SMS communication
  - name: Analytics
    description: Reporting and analytics

paths:
  # ====================
  # Core Endpoints
  # ====================
  
  /upload:
    post:
      tags:
        - Core
      summary: Upload CSV data
      description: Upload and process CSV files for clinics, patients, appointments, or stock
      requestBody:
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
                - file_type
              properties:
                file:
                  type: string
                  format: binary
                  description: CSV file to upload
                file_type:
                  type: string
                  enum: [clinics, patients, appointments, stock]
                  description: Type of data being uploaded
      responses:
        '200':
          description: Upload successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'

  /dashboard:
    get:
      tags:
        - Core
      summary: Get dashboard data
      description: Retrieve aggregated dashboard data including upcoming visits, missed visits, and low stock items
      parameters:
        - name: clinic_id
          in: query
          schema:
            type: string
          description: Filter by specific clinic
      responses:
        '200':
          description: Dashboard data retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DashboardResponse'
        '500':
          $ref: '#/components/responses/InternalError'

  # ====================
  # Prediction Endpoints
  # ====================
  
  /predictions/calculate:
    post:
      tags:
        - Predictions
      summary: Calculate no-show risk score
      description: |
        Calculate risk score for a specific appointment with <100ms latency target.
        Uses ML model for 500+ records, falls back to rule-based for smaller datasets.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - patient_id
                - appointment_id
              properties:
                patient_id:
                  type: string
                  description: Patient identifier
                appointment_id:
                  type: string
                  description: Appointment identifier
                include_factors:
                  type: boolean
                  default: false
                  description: Include detailed factor breakdown
      responses:
        '200':
          description: Risk score calculated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RiskScore'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'

  /predictions/batch:
    post:
      tags:
        - Predictions
      summary: Calculate risk scores in batch
      description: Calculate risk scores for multiple appointments (max 100 per request)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - appointments
              properties:
                appointments:
                  type: array
                  maxItems: 100
                  items:
                    type: object
                    properties:
                      patient_id:
                        type: string
                      appointment_id:
                        type: string
      responses:
        '200':
          description: Batch calculation complete
          content:
            application/json:
              schema:
                type: object
                properties:
                  risk_scores:
                    type: array
                    items:
                      $ref: '#/components/schemas/RiskScore'
                  processing_time_ms:
                    type: number

  /predictions/patterns:
    get:
      tags:
        - Predictions
      summary: Analyze no-show patterns
      description: Get historical no-show patterns and trends
      parameters:
        - name: clinic_id
          in: query
          required: true
          schema:
            type: string
        - name: date_from
          in: query
          required: true
          schema:
            type: string
            format: date
        - name: date_to
          in: query
          required: true
          schema:
            type: string
            format: date
        - name: group_by
          in: query
          schema:
            type: string
            enum: [day, week, month]
            default: week
      responses:
        '200':
          description: Pattern analysis complete
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PatternAnalysis'

  # ====================
  # Scheduling Endpoints
  # ====================
  
  /scheduling/overbook:
    post:
      tags:
        - Scheduling
      summary: Get overbooking recommendations
      description: |
        Calculate optimal overbooking level based on predicted no-shows.
        Maximum overbooking capped at 125% for safety.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - clinic_id
                - date
                - time_slot
              properties:
                clinic_id:
                  type: string
                date:
                  type: string
                  format: date
                time_slot:
                  type: string
                  enum: [MORNING, AFTERNOON]
      responses:
        '200':
          description: Overbooking recommendation generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OverbookingConfig'

  /scheduling/optimize-week:
    post:
      tags:
        - Scheduling
      summary: Optimize weekly schedule
      description: Generate overbooking recommendations for entire week
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - clinic_id
                - week_start
              properties:
                clinic_id:
                  type: string
                week_start:
                  type: string
                  format: date
                  description: Monday of the week to optimize
      responses:
        '200':
          description: Weekly optimization complete
          content:
            application/json:
              schema:
                type: object
                properties:
                  optimizations:
                    type: array
                    items:
                      $ref: '#/components/schemas/OverbookingConfig'
                  expected_improvement:
                    type: number
                    description: Expected improvement in utilization percentage

  /scheduling/capacity:
    get:
      tags:
        - Scheduling
      summary: Get current capacity status
      description: Get real-time capacity utilization for a clinic
      parameters:
        - name: clinic_id
          in: query
          required: true
          schema:
            type: string
        - name: date
          in: query
          schema:
            type: string
            format: date
            description: Defaults to today
      responses:
        '200':
          description: Capacity status retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CapacityStatus'

  # ====================
  # Waitlist Endpoints
  # ====================
  
  /waitlist/add:
    post:
      tags:
        - Waitlist
      summary: Add patient to waitlist
      description: Add patient to waitlist with priority calculation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WaitlistEntryRequest'
      responses:
        '201':
          description: Added to waitlist
          content:
            application/json:
              schema:
                type: object
                properties:
                  entry_id:
                    type: string
                  estimated_wait:
                    type: string
                    description: Estimated wait time in human-readable format
                  position:
                    type: integer
                    description: Position in queue

  /waitlist/next:
    get:
      tags:
        - Waitlist
      summary: Get next candidates for slot
      description: Get prioritized list of candidates for an available slot
      parameters:
        - name: clinic_id
          in: query
          required: true
          schema:
            type: string
        - name: slot_datetime
          in: query
          required: true
          schema:
            type: string
            format: date-time
        - name: count
          in: query
          schema:
            type: integer
            default: 5
            minimum: 1
            maximum: 20
      responses:
        '200':
          description: Candidates retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  candidates:
                    type: array
                    items:
                      $ref: '#/components/schemas/WaitlistEntry'
                  match_scores:
                    type: array
                    items:
                      type: number
                      description: Match score 0-100

  /waitlist/notify:
    post:
      tags:
        - Waitlist
      summary: Notify waitlist patients
      description: Send SMS notifications to waitlist patients about available slot
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - entry_ids
                - slot_datetime
              properties:
                entry_ids:
                  type: array
                  items:
                    type: string
                slot_datetime:
                  type: string
                  format: date-time
      responses:
        '200':
          description: Notifications sent
          content:
            application/json:
              schema:
                type: object
                properties:
                  sent_count:
                    type: integer
                  failed_count:
                    type: integer

  # ====================
  # SMS Endpoints
  # ====================
  
  /sms/send:
    post:
      tags:
        - SMS
      summary: Send SMS message
      description: Send SMS with optional reply code expectation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - phone
                - message
                - language
              properties:
                phone:
                  type: string
                  pattern: '^\+[1-9]\d{1,14}$'
                  description: E.164 format phone number
                message:
                  type: string
                  maxLength: 160
                language:
                  type: string
                  enum: [EN, TSW]
                type:
                  type: string
                  enum: [REMINDER, CONFIRMATION, WAITLIST]
                  default: REMINDER
                expect_reply:
                  type: boolean
                  default: false
                appointment_id:
                  type: string
      responses:
        '200':
          description: SMS queued
          content:
            application/json:
              schema:
                type: object
                properties:
                  interaction_id:
                    type: string
                  status:
                    type: string
                    enum: [QUEUED, SENT]

  /sms/receive:
    post:
      tags:
        - SMS
      summary: Process inbound SMS
      description: Process patient SMS response (webhook endpoint)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - phone
                - message
                - received_at
              properties:
                phone:
                  type: string
                message:
                  type: string
                received_at:
                  type: string
                  format: date-time
                gateway_id:
                  type: string
      responses:
        '200':
          description: Response processed
          content:
            application/json:
              schema:
                type: object
                properties:
                  action_taken:
                    type: string
                    enum: [RESCHEDULED_TOMORROW, RESCHEDULED_NEXT_WEEK, CONFIRMED_WAITLIST, NO_ACTION]
                  appointment_updated:
                    type: boolean
                  next_steps:
                    type: array
                    items:
                      type: string

  /sms/conversations:
    get:
      tags:
        - SMS
      summary: Get SMS conversation threads
      description: Retrieve SMS conversation history for a patient
      parameters:
        - name: patient_id
          in: query
          schema:
            type: string
        - name: phone
          in: query
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: Conversations retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  conversations:
                    type: array
                    items:
                      $ref: '#/components/schemas/SMSInteraction'

  # ====================
  # Analytics Endpoints
  # ====================
  
  /analytics/no-show-trends:
    get:
      tags:
        - Analytics
      summary: Get no-show trends
      description: Analyze no-show trends over time
      parameters:
        - name: clinic_id
          in: query
          schema:
            type: string
        - name: period
          in: query
          schema:
            type: string
            enum: [7d, 30d, 90d, 1y]
            default: 30d
      responses:
        '200':
          description: Trends analyzed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TrendAnalysis'

  /analytics/utilization:
    get:
      tags:
        - Analytics
      summary: Get capacity utilization metrics
      description: Analyze clinic capacity utilization
      parameters:
        - name: clinic_id
          in: query
          required: true
          schema:
            type: string
        - name: date_from
          in: query
          required: true
          schema:
            type: string
            format: date
        - name: date_to
          in: query
          required: true
          schema:
            type: string
            format: date
      responses:
        '200':
          description: Utilization metrics calculated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UtilizationMetrics'

  /analytics/roi:
    get:
      tags:
        - Analytics
      summary: Calculate ROI metrics
      description: Calculate return on investment for prediction system
      parameters:
        - name: clinic_id
          in: query
          schema:
            type: string
        - name: period
          in: query
          schema:
            type: string
            enum: [month, quarter, year]
            default: month
      responses:
        '200':
          description: ROI calculated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ROIMetrics'

  # ====================
  # Quick Action Endpoints
  # ====================
  
  /appointments/reschedule:
    post:
      tags:
        - Core
      summary: Quick reschedule with suggestions
      description: Reschedule appointment with smart slot suggestions
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - appointment_id
              properties:
                appointment_id:
                  type: string
                reason:
                  type: string
                preferred_dates:
                  type: array
                  items:
                    type: string
                    format: date
      responses:
        '200':
          description: Reschedule options generated
          content:
            application/json:
              schema:
                type: object
                properties:
                  suggested_slots:
                    type: array
                    items:
                      type: object
                      properties:
                        datetime:
                          type: string
                          format: date-time
                        availability:
                          type: number
                          description: Percentage of capacity available
                        no_show_risk:
                          type: number
                          description: Predicted no-show risk if rescheduled
                  waitlist_notified:
                    type: integer
                    description: Number of waitlist patients notified

components:
  schemas:
    # Core Schemas
    UploadResponse:
      type: object
      properties:
        success:
          type: boolean
        records_processed:
          type: integer
        errors:
          type: array
          items:
            type: object
            properties:
              row:
                type: integer
              field:
                type: string
              message:
                type: string
    
    DashboardResponse:
      type: object
      properties:
        upcoming_visits:
          type: array
          items:
            $ref: '#/components/schemas/AppointmentDetail'
        missed_visits:
          type: array
          items:
            $ref: '#/components/schemas/AppointmentDetail'
        low_stock_items:
          type: array
          items:
            $ref: '#/components/schemas/StockItem'
        stats:
          type: object
          properties:
            total_clinics:
              type: integer
            total_patients:
              type: integer
            avg_no_show_rate:
              type: number
    
    AppointmentDetail:
      type: object
      properties:
        appointment_id:
          type: string
        patient_id:
          type: string
        patient_name:
          type: string
        visit_date:
          type: string
          format: date
        visit_type:
          type: string
        risk_score:
          type: number
          nullable: true
        risk_level:
          type: string
          enum: [LOW, MEDIUM, HIGH]
          nullable: true
    
    StockItem:
      type: object
      properties:
        stock_id:
          type: string
        item_name:
          type: string
        on_hand_qty:
          type: integer
        reorder_level:
          type: integer
        unit:
          type: string
        shortage_qty:
          type: integer
          description: Amount below reorder level
    
    # Prediction Schemas
    RiskScore:
      type: object
      required:
        - patient_id
        - appointment_id
        - risk_percentage
        - risk_level
      properties:
        patient_id:
          type: string
        appointment_id:
          type: string
        risk_percentage:
          type: number
          minimum: 0
          maximum: 100
        risk_level:
          type: string
          enum: [LOW, MEDIUM, HIGH]
        calculated_at:
          type: string
          format: date-time
        factors:
          type: object
          properties:
            distance_km:
              type: number
            no_show_history:
              type: number
            weather_impact:
              type: number
            demographic_score:
              type: number
        metadata:
          type: object
          properties:
            transport_mode:
              type: string
              enum: [WALKING, COMBI, PRIVATE, UNKNOWN]
            day_of_week:
              type: string
            time_slot:
              type: string
              enum: [MORNING, AFTERNOON]
            is_chronic_care:
              type: boolean
        confidence:
          type: object
          properties:
            score:
              type: number
            sample_size:
              type: integer
            model_version:
              type: string
        recommendations:
          type: array
          items:
            type: string
    
    PatternAnalysis:
      type: object
      properties:
        by_day_of_week:
          type: object
          additionalProperties:
            type: number
        by_time_slot:
          type: object
          additionalProperties:
            type: number
        by_demographics:
          type: object
          properties:
            by_age_group:
              type: object
              additionalProperties:
                type: number
            by_gender:
              type: object
              additionalProperties:
                type: number
        trends:
          type: object
          properties:
            direction:
              type: string
              enum: [IMPROVING, WORSENING, STABLE]
            percentage_change:
              type: number
    
    # Scheduling Schemas
    OverbookingConfig:
      type: object
      properties:
        clinic_id:
          type: string
        date:
          type: string
          format: date
        time_slot:
          type: string
          enum: [MORNING, AFTERNOON]
        capacity:
          type: object
          properties:
            baseline:
              type: integer
            maximum:
              type: integer
            current:
              type: integer
            recommended:
              type: integer
        factors:
          type: object
          properties:
            historical_no_show_rate:
              type: number
            day_of_week_multiplier:
              type: number
            seasonal_adjustment:
              type: number
            staff_availability:
              type: number
        constraints:
          type: object
          properties:
            max_overbook_percentage:
              type: integer
            min_staff_ratio:
              type: number
            emergency_buffer:
              type: integer
        impact_analysis:
          type: object
          properties:
            expected_utilization:
              type: number
            risk_assessment:
              type: string
    
    CapacityStatus:
      type: object
      properties:
        morning:
          $ref: '#/components/schemas/SlotCapacity'
        afternoon:
          $ref: '#/components/schemas/SlotCapacity'
    
    SlotCapacity:
      type: object
      properties:
        total_slots:
          type: integer
        booked_slots:
          type: integer
        available_slots:
          type: integer
        overbooked_slots:
          type: integer
        utilization_percentage:
          type: number
    
    # Waitlist Schemas
    WaitlistEntryRequest:
      type: object
      required:
        - patient_id
        - clinic_id
        - priority_level
      properties:
        patient_id:
          type: string
        clinic_id:
          type: string
        earliest_date:
          type: string
          format: date
        latest_date:
          type: string
          format: date
        preferred_times:
          type: array
          items:
            type: string
            pattern: '^([01]?[0-9]|2[0-3]):[0-5][0-9]$'
        priority_level:
          type: integer
          minimum: 1
          maximum: 5
          description: 1=Urgent, 5=Routine
        medical_urgency:
          type: string
        max_distance_km:
          type: number
    
    WaitlistEntry:
      allOf:
        - $ref: '#/components/schemas/WaitlistEntryRequest'
        - type: object
          properties:
            entry_id:
              type: string
            priority_score:
              type: number
            status:
              type: string
              enum: [WAITING, NOTIFIED, SCHEDULED, EXPIRED]
            wait_time_days:
              type: integer
            added_at:
              type: string
              format: date-time
            expires_at:
              type: string
              format: date-time
    
    # SMS Schemas
    SMSInteraction:
      type: object
      properties:
        interaction_id:
          type: string
        patient_id:
          type: string
        phone_number:
          type: string
        direction:
          type: string
          enum: [OUTBOUND, INBOUND]
        message:
          type: object
          properties:
            content:
              type: string
            language:
              type: string
              enum: [EN, TSW]
            char_count:
              type: integer
        context:
          type: object
          properties:
            appointment_id:
              type: string
            interaction_type:
              type: string
              enum: [REMINDER, RESCHEDULE, CONFIRMATION, WAITLIST]
            reply_expected:
              type: boolean
        status:
          type: string
          enum: [QUEUED, SENT, DELIVERED, FAILED, REPLIED]
        timestamps:
          type: object
          properties:
            created_at:
              type: string
              format: date-time
            sent_at:
              type: string
              format: date-time
            delivered_at:
              type: string
              format: date-time
            replied_at:
              type: string
              format: date-time
    
    # Analytics Schemas
    TrendAnalysis:
      type: object
      properties:
        period:
          type: string
        data_points:
          type: array
          items:
            type: object
            properties:
              date:
                type: string
                format: date
              no_show_rate:
                type: number
              total_appointments:
                type: integer
              no_shows:
                type: integer
        trend_line:
          type: object
          properties:
            slope:
              type: number
            direction:
              type: string
              enum: [INCREASING, DECREASING, STABLE]
        forecast:
          type: array
          items:
            type: object
            properties:
              date:
                type: string
                format: date
              predicted_rate:
                type: number
              confidence_interval:
                type: object
                properties:
                  lower:
                    type: number
                  upper:
                    type: number
    
    UtilizationMetrics:
      type: object
      properties:
        average_utilization:
          type: number
        peak_utilization:
          type: number
        low_utilization_days:
          type: integer
        overbooked_days:
          type: integer
        optimal_days:
          type: integer
        by_day_of_week:
          type: object
          additionalProperties:
            type: number
        by_time_slot:
          type: object
          additionalProperties:
            type: number
    
    ROIMetrics:
      type: object
      properties:
        period:
          type: string
        appointments_recovered:
          type: integer
          description: Appointments saved through prediction
        revenue_impact:
          type: number
          description: Estimated revenue impact in BWP
        efficiency_gain:
          type: number
          description: Percentage improvement in utilization
        cost_savings:
          type: object
          properties:
            sms_optimization:
              type: number
            staff_time:
              type: number
            overhead_reduction:
              type: number
        roi_percentage:
          type: number
          description: Return on investment percentage
    
    # Error Schemas
    Error:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
        message:
          type: string
        details:
          type: object
  
  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    
    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
  
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
    
    apiKey:
      type: apiKey
      in: header
      name: X-API-Key

security:
  - bearerAuth: []
  - apiKey: []